#!/bin/sh
set -e

should_deploy=false
while read local_ref local_sha remote_ref remote_sha; do
  if [ "$local_ref" = "refs/heads/main" ]; then
    should_deploy=true
  fi
done

if [ "$should_deploy" != "true" ]; then
  exit 0
fi

if [ "${AGR_DEPLOYING:-}" = "1" ]; then
  exit 0
fi

echo "[post-push] Deploying to gh-pages..."
{
  echo "----- $(date) -----"
  AGR_DEPLOYING=1 npm run deploy
} 2>&1 | tee -a .git/post-push.log
